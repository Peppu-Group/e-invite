<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Status Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        #app {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .upload-group {
            margin-bottom: 20px;
        }
        
        .upload-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1em;
        }
        
        .file-input {
            display: block;
            width: 100%;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-input:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }
        
        .process-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }
        
        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }
        
        .results-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
        }
        
        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        
        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f8f9ff;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-sent {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-delivered {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .status-read {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status-failed {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .status-unknown {
            background: #f5f5f5;
            color: #757575;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .error {
            background: #ffebee;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ðŸ“Š Message Status Dashboard</h1>
            <p>Track and monitor message delivery status</p>
        </div>
        
        <div v-if="error" class="error">{{ error }}</div>
        
        <div v-if="results.length > 0" class="stats">
            <div class="stat-card">
                <h3>Total Messages</h3>
                <div class="number">{{ results.length }}</div>
            </div>
            <div class="stat-card">
                <h3>Read</h3>
                <div class="number" style="color: #388e3c;">{{ statusCounts.read }}</div>
            </div>
            <div class="stat-card">
                <h3>Delivered</h3>
                <div class="number" style="color: #f57c00;">{{ statusCounts.delivered }}</div>
            </div>
            <div class="stat-card">
                <h3>Sent</h3>
                <div class="number" style="color: #1976d2;">{{ statusCounts.sent }}</div>
            </div>
            <div class="stat-card">
                <h3>Failed</h3>
                <div class="number" style="color: #d32f2f;">{{ statusCounts.failed }}</div>
            </div>
            <div class="stat-card">
                <h3>Unknown</h3>
                <div class="number" style="color: #757575;">{{ statusCounts.unknown }}</div>
            </div>
        </div>
        
        <div v-if="results.length > 0" class="results-section">
            <input 
                type="text" 
                class="search-box" 
                v-model="searchQuery" 
                placeholder="ðŸ” Search by name, phone, or message ID...">
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Message ID</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="result in filteredResults" :key="result.messageId">
                            <td>{{ result.name }}</td>
                            <td>{{ result.phone }}</td>
                            <td style="font-family: monospace; font-size: 0.85em;">{{ result.messageId }}</td>
                            <td>
                                <span :class="'status-badge status-' + result.status.toLowerCase()">
                                    {{ result.status }}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div v-if="!processing && results.length === 0 && !error" class="results-section">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
                <h3>No Data Yet</h3>
                <p>Upload your CSV and log files to get started</p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    csvData: null,
                    logData: null,
                    results: [],
                    searchQuery: '',
                    processing: false,
                    error: null,
                    // Hardcoded CSV data - replace with your actual data
                    hardcodedCSV: ``
                };
            },
            async mounted() {
                this.getWebLog();
                // Auto-load hardcoded data
                await this.loadHardcodedData();
            },
            computed: {
                filteredResults() {
                    if (!this.searchQuery) return this.results;
                    
                    const query = this.searchQuery.toLowerCase();
                    return this.results.filter(result => 
                        result.name.toLowerCase().includes(query) ||
                        result.phone.toLowerCase().includes(query) ||
                        result.messageId.toLowerCase().includes(query) ||
                        result.status.toLowerCase().includes(query)
                    );
                },
                statusCounts() {
                    const counts = {
                        read: 0,
                        delivered: 0,
                        sent: 0,
                        failed: 0,
                        unknown: 0
                    };
                    
                    this.results.forEach(result => {
                        const status = result.status.toLowerCase();
                        if (counts.hasOwnProperty(status)) {
                            counts[status]++;
                        }
                    });
                    
                    return counts;
                }
            },
            methods: {
                async getWebLog() {
                    try {
                        // Fetch log
                        const logResponse = await fetch('https://proctoredserver.peppubuild.com/logs');
                        const logText = await logResponse.text();
                        this.hardcodedLog = logText;
                        // Process them...
                    } catch (error) {
                        console.error('Error loading files:', error);
                    }
                },
                async loadHardcodedData() {
                    try {
                        this.processing = true;
                        console.log('Loading hardcoded data...');
                        
                        // Parse hardcoded CSV
                        Papa.parse(this.hardcodedCSV, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                this.csvData = results.data;
                                console.log('CSV loaded:', this.csvData.length, 'records');
                            },
                            error: (error) => {
                                throw new Error('Error parsing CSV: ' + error.message);
                            }
                        });

                        // Parse hardcoded log
                        this.logData = this.parseLogFile(this.hardcodedLog);
                        console.log('Log loaded:', Object.keys(this.logData).length, 'message IDs');

                        // Auto-process if both loaded
                        if (this.csvData && this.logData) {
                            setTimeout(() => this.processData(), 500);
                        }
                        
                        this.processing = false;
                    } catch (error) {
                        this.error = 'Could not load hardcoded data: ' + error.message;
                        console.error('Error loading data:', error);
                        this.processing = false;
                    }
                },
                
                async loadFilesFromRoot() {
                    try {
                        this.processing = true;
                        console.log('Fetching files from server...');
                        
                        // Fetch CSV file
                        const csvResponse = await fetch('https://proctoredserver.peppubuild.com/chiaka-update.csv');
                        if (!csvResponse.ok) throw new Error(`CSV fetch failed: ${csvResponse.status}`);
                        const csvText = await csvResponse.text();
                        
                        Papa.parse(csvText, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                this.csvData = results.data;
                                console.log('CSV loaded from server:', this.csvData.length, 'records');
                            },
                            error: (error) => {
                                throw new Error('Error parsing CSV: ' + error.message);
                            }
                        });

                        // Fetch log file
                        const logResponse = await fetch('https://proctoredserver.peppubuild.com/webhook.log');
                        if (!logResponse.ok) throw new Error(`Log fetch failed: ${logResponse.status}`);
                        const logText = await logResponse.text();
                        this.logData = this.parseLogFile(logText);
                        console.log('Log loaded from server:', Object.keys(this.logData).length, 'message IDs');

                        // Auto-process if both files loaded
                        if (this.csvData && this.logData) {
                            setTimeout(() => this.processData(), 500);
                        }
                        
                        this.processing = false;
                    } catch (error) {
                        this.error = 'Could not load files from server: ' + error.message;
                        console.error('Error loading files:', error);
                        this.processing = false;
                    }
                },
                handleCSVUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    this.error = null;
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        Papa.parse(e.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                this.csvData = results.data;
                                console.log('CSV loaded:', this.csvData.length, 'records');
                            },
                            error: (error) => {
                                this.error = 'Error parsing CSV: ' + error.message;
                            }
                        });
                    };
                    
                    reader.readAsText(file);
                },
                
                handleLogUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    this.error = null;
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const content = e.target.result;
                            this.logData = this.parseLogFile(content);
                            console.log('Log loaded:', Object.keys(this.logData).length, 'message IDs');
                        } catch (error) {
                            this.error = 'Error parsing log file: ' + error.message;
                        }
                    };
                    
                    reader.readAsText(file);
                },
                
                parseLogFile(content) {
                    const statusMap = {};
                    const lines = content.split('\n');
                    
                    // Regex to extract message ID and status
                    // Pattern: [timestamp] ðŸ“© Message <messageId> to <phone> is now <status>
                    const pattern = /Message\s+(wamid\.[^\s]+)\s+to\s+\d+\s+is\s+now\s+(\w+)/;
                    
                    lines.forEach(line => {
                        const match = line.match(pattern);
                        if (match) {
                            const messageId = match[1];
                            const status = match[2];
                            statusMap[messageId] = status;
                        }
                    });
                    
                    return statusMap;
                },
                
                processData() {
                    if (!this.csvData || !this.logData) {
                        this.error = 'Please upload both CSV and log files';
                        return;
                    }
                    
                    this.processing = true;
                    this.error = null;
                    this.results = [];
                    
                    setTimeout(() => {
                        try {
                            console.log('CSV Data sample:', this.csvData[0]);
                            console.log('CSV columns:', Object.keys(this.csvData[0]));
                            console.log('Log Data sample:', Object.keys(this.logData).slice(0, 3));
                            
                            this.csvData.forEach((row, index) => {
                                // Try multiple variations of column names
                                const name = row.name || row.Name || row.NAME || 
                                            row['Name'] || row['name'] || '';
                                const phone = row.phone || row.Phone || row.PHONE || 
                                             row['Phone'] || row['phone'] || '';
                                const messageId = row.messageId || row.MessageId || row.messageid || 
                                                 row.MESSAGEID || row.message_id || row.MessageID ||
                                                 row['messageId'] || row['MessageId'] || row['message_id'] || '';
                                
                                console.log(`Row ${index}:`, { name, phone, messageId: messageId.substring(0, 20) + '...' });
                                
                                if (!messageId) {
                                    console.warn(`Row ${index} has no messageId`);
                                    return;
                                }
                                
                                const status = this.logData[messageId] || 'Unknown';
                                
                                this.results.push({
                                    name: name.trim(),
                                    phone: phone.trim(),
                                    messageId: messageId.trim(),
                                    status: status.charAt(0).toUpperCase() + status.slice(1).toLowerCase()
                                });
                            });
                            
                            console.log('Processing complete:', this.results.length, 'results');
                            
                            if (this.results.length === 0) {
                                this.error = 'No results generated. Check console for debugging info. Make sure your CSV has columns: name, phone, and messageId';
                            }
                        } catch (error) {
                            this.error = 'Error processing data: ' + error.message;
                            console.error('Processing error:', error);
                        } finally {
                            this.processing = false;
                        }
                    }, 100);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>